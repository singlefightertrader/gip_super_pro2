<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GIP V5 · SOVEREIGN ENGINE</title>

<style>
body{margin:0;font-family:Arial;background:#0b0f18;color:#fff;padding:15px;}
.card{background:#141a2a;border:1px solid #1f2940;border-radius:12px;padding:15px;margin-bottom:15px;}
h2{margin-top:0;color:#00eaff;}
input{width:100%;padding:8px;margin:4px 0;background:#000;border:1px solid #00eaff;color:#0ff;border-radius:6px;}
button{width:100%;padding:10px;margin-top:6px;border-radius:6px;font-weight:bold;background:#101828;border:1px solid #00eaff;color:#0ff;cursor:pointer;}
.status{padding:8px;margin:5px 0;border-radius:6px;text-align:center;}
.green{color:#00ff99;}
.red{color:#ff4d4d;}
.yellow{color:#ffcc00;}
.gray{color:#aaa;}
.big{font-size:20px;font-weight:bold;}
.bar{height:8px;background:#222;border-radius:5px;overflow:hidden;margin-top:5px;}
.fill{height:100%;background:linear-gradient(90deg,#ff4d4d,#ffcc00,#00ff99);width:0%;}
.small{font-size:12px;color:#aaa;margin-top:5px;white-space:pre-line;}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;}
.log{background:#0a0e14;padding:8px;border-radius:6px;font-family:monospace;font-size:11px;height:120px;overflow-y:auto;color:#0ff;}
.deepBox{background:#101826;border:1px solid #23304a;padding:10px;border-radius:8px;margin-top:6px;}

/* MISSION PRICE STYLES */
.mission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.m-box { padding: 10px; border-radius: 6px; font-weight: bold; font-size: 13px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
.m-h1 { background: #9b59b6; color: #fff; border-left: 5px solid #fff; } 
.m-m30 { background: #2980b9; color: #fff; border-left: 5px solid #fff; } 
.m-m15 { background: #f1c40f; color: #000; border-left: 5px solid #000; } 
.m-m5 { background: #2ecc71; color: #000; border-left: 5px solid #000; } 

/* ANIMATION BLINK */
@keyframes blinker { 50% { opacity: 0.3; } }
.blink-warning { animation: blinker 1s linear infinite; background:#4d0000; border:2px solid #ff0000; color:#ff4d4d; padding:12px; border-radius:8px; margin-bottom:15px; text-align:center; font-weight:bold; }

.input-layer { background: #1a2235; border: 2px solid #00eaff; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
.layer-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
.btn-add { background: #00eaff !important; color: #000 !important; }

.clock-display { font-size: 24px; color: #ffcc00; text-align: center; font-weight: bold; margin-bottom: 10px; }
.news-alert-box { border: 1px dashed #ff4d4d; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
</style>
</head>
<body>

<div class="card">
    <div id="mt5Clock" class="clock-display">00:00:00 (LOADING...)</div>
    <div id="h1CloseWarning" class="blink-warning" style="display:none;">
    ⚠ H1 CLOSING ZONE ACTIVE<br>
    Zona manipulasi / liquidity sweep (Menit 50-00).<br>
    Ketidaksabaran adalah musuh profit.
    </div>
    <div class="news-alert-box">
        <h3 style="margin:0 0 5px 0; font-size:14px; color:#ff4d4d;">🔔 MANUAL NEWS ALERT</h3>
        <div style="display:flex; gap:5px;">
            <input type="time" id="newsTime" style="flex:1;">
            <input type="text" id="newsTitle" placeholder="Event Name" style="flex:2;">
            <button onclick="setNewsAlert()" style="width: auto; margin:0; padding: 5px 15px;">SET</button>
        </div>
        <div id="activeAlerts" class="small yellow" style="margin-top:5px;"></div>
    </div>
</div>

<div class="card input-layer">
    <h2>🕯️ LIVE M5 CANDLE INPUT</h2>
    <div class="layer-grid">
        <div>High <input type="number" id="m5_high" step="0.001"></div>
        <div>Low <input type="number" id="m5_low" step="0.001"></div>
        <div>Close <input type="number" id="m5_close" step="0.001"></div>
    </div>
    <button class="btn-add" onclick="addM5Candle()">ADD CANDLE & UPDATE STRUCTURE</button>
</div>

<div class="card">
<h2>🔒 LOCK STRUCTURE (1x per H1)</h2>
H1 High <input type="number" id="h1h">
H1 Low <input type="number" id="h1l">
M30 High <input type="number" id="m30h">
M30 Low <input type="number" id="m30l">
M15 High <input type="number" id="m15h">
M15 Low <input type="number" id="m15l">
<button onclick="lockLevels()">LOCK STRUCTURE</button>
<button onclick="resetStructureOnly()" style="background:#4d331a; margin-top:5px;">🗑 RESET STRUCTURE</button>
<div id="lockInfo" class="small"></div>
</div>

<div class="card">
<h2>🏦 H2 / H4 FILTER</h2>
H4 High <input type="number" id="h4h">
H4 Low <input type="number" id="h4l">
H2 High <input type="number" id="h2h">
H2 Low <input type="number" id="h2l">
<button onclick="setInstitutional()">SET FILTER</button>
<button onclick="resetFilterOnly()" style="background:#4d331a; margin-top:5px;">🗑 RESET FILTER</button>
<div id="institutionInfo" class="small"></div>
</div>

<div class="card">
<h2>📥 M5 MEMORY (12 SLOT)</h2>
<div class="grid">
<input type="number" id="m5_1"><input type="number" id="m5_2"><input type="number" id="m5_3">
<input type="number" id="m5_4"><input type="number" id="m5_5"><input type="number" id="m5_6">
<input type="number" id="m5_7"><input type="number" id="m5_8"><input type="number" id="m5_9">
<input type="number" id="m5_10"><input type="number" id="m5_11"><input type="number" id="m5_12">
</div>
<button onclick="processEngine()">PROCESS ENGINE</button>
<button onclick="resetM5Only()" style="background:#4d331a; margin-top:5px;">🗑 RESET M5 MEMORY</button>
</div>

<div class="card">
<h2>📊 ENGINE STATUS</h2>
<div id="h1Status" class="status gray">H1: WAIT</div>
<div id="m30Status" class="status gray">M30: WAIT</div>
<div id="m15Status" class="status gray">M15: WAIT</div>
<div id="m5Status" class="status gray">M5: WAIT</div>
<div id="flowStatus" class="status gray">FLOW: -</div>
<div id="pressureStatus" class="status gray">PRESSURE: 0</div>
<div id="finalStatus" class="status big gray">FINAL: -</div>
<div class="bar"><div id="confidenceBar" class="fill"></div></div>
</div>

<div class="card">
<h2>🏛 HTF EXTREME ZONE</h2>
<div id="htfZoneStatus" class="status gray">ZONE: -</div>
<div id="htfZoneDetail" class="small"></div>
</div>

<div class="card">
<h2>🎯 DYNAMIC MISSION PRICES</h2>
<div class="mission-grid">
    <div id="missionH1" class="m-box m-h1">H1 Target: -</div>
    <div id="missionM30" class="m-box m-m30">M30 Target: -</div>
    <div id="missionM15" class="m-box m-m15">M15 Target: -</div>
    <div id="missionM5" class="m-box m-m5">M5 Target: -</div>
</div>
</div>

<!-- ========== ADDED CARD: STRUCTURAL MISI HARGA ========== -->
<div class="card">
<h2>📌 STRUCTURAL MISI HARGA</h2>
<div class="mission-grid" id="structuralMissionGrid">
    <div id="structuralH1" class="m-box m-h1">H1 Structural: -</div>
    <div id="structuralM30" class="m-box m-m30">M30 Structural: -</div>
    <div id="structuralM15" class="m-box m-m15">M15 Structural: -</div>
    <div id="structuralM5" class="m-box m-m5">M5 Structural: -</div>
</div>
</div>
<!-- ========== END ADDED CARD ========== -->

<!-- ========== MANUAL BIAS LOCK CARD ========== -->
<div class="card">
    <h2>🧲 MANUAL BIAS LOCK</h2>
    <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="setManualBias('BUY')" style="background: #00aa00; flex:1;">BUY</button>
        <button onclick="setManualBias('SELL')" style="background: #aa0000; flex:1;">SELL</button>
        <button onclick="setManualBias(null)" style="background: #333; flex:1;">CLEAR</button>
    </div>
    <div id="manualBiasDisplay" class="small" style="text-align: center; margin-top: 10px;">Bias: -</div>
</div>
<!-- ========== END MANUAL BIAS ========== -->

<div class="card">
<h2>🧠 DEEP ENGINE INTERPRETATION</h2>
<div class="deepBox" id="deepConclusion" style="white-space: pre-wrap;"></div>
</div>

<div class="card">
<h2>🛡 RISK ENGINE</h2>
RR <input type="number" id="rrInput" value="2" step="0.1">
<div id="entry" class="small"></div>
<div id="sl" class="small"></div>
<div id="tp" class="small"></div>
</div>

<div class="card">
<h2>🎖️ TACTICAL AI DISCIPLINE</h2>
<div id="tacticalCommanderBox" class="deepBox">WAITING DATA...</div>
</div>

<div class="card">
<h2>📝 GOLDEN LOG</h2>
<div id="log" class="log"></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-top:10px;">
    <button onclick="exportData()" style="background:#1a4d1a;">📥 EXPORT</button>
    <button onclick="importData()" style="background:#1a2b4d;">📤 IMPORT</button>
    <button onclick="resetSystem()" style="background:#4d1a1a;">🗑 RESET TOTAL</button>
</div>
</div>

<script>
let m5Memory = [];
let levels = null;
let institutional = null;
let lockedHour = null;
let logData = [];
let activeNewsAlerts = [];
let MT5_OFFSET_HOURS = 0; 
// ===== ADDED VARIABLE =====
let structuralMission = {}; // untuk structural mission
// ===== MAGNET DATA =====
let magnetData = null;
// ===== PSYCHOLOGY ZONE DATA =====
let psychoZone = null;
// ===== MANUAL BIAS =====
let manualBias = null;

function setManualBias(bias) {
    manualBias = bias;
    document.getElementById("manualBiasDisplay").innerText = bias ? "Bias: " + bias : "Bias: -";
    // Trigger update jika engine sudah punya data
    if (levels) processEngine();
}

function getMT5Time() {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    return new Date(utc + (MT5_OFFSET_HOURS * 3600000));
}

function startMT5Clock() {
    setInterval(() => {
        const mt5 = getMT5Time();
        const h = String(mt5.getHours()).padStart(2, '0');
        const m = String(mt5.getMinutes()).padStart(2, '0');
        const s = String(mt5.getSeconds()).padStart(2, '0');
        const clockStr = `${h}:${m}:${s}`;
        document.getElementById("mt5Clock").innerText = clockStr + " (MT5 SERVER)";
        checkNewsAlerts(clockStr);
        checkH1ClosingZone(mt5); 
    }, 1000);
}

function checkH1ClosingZone(mt5DateObj){
    const minute = mt5DateObj.getMinutes();
    const warningBox = document.getElementById("h1CloseWarning");
    warningBox.style.display = (minute >= 50) ? "block" : "none";
}

function detectHTFExtreme(price){
    if(!institutional || !institutional.H4) return;
    let high = institutional.H4.high;
    let low = institutional.H4.low;
    let range = high - low;
    if(range <= 0) return;
    let upperZone = high - (range * 0.2);
    let lowerZone = low + (range * 0.2);
    let zone = "MID RANGE", detail = "Harga berada di tengah struktur H4.", color = "green";
    if(price >= upperZone){ zone = "⚠ DISTRIBUTION ZONE"; detail = "Dekat H4 High. Risiko dump."; color = "red"; }
    if(price <= lowerZone){ zone = "⚠ ACCUMULATION ZONE"; detail = "Dekat H4 Low. Risiko pump."; color = "red"; }
    document.getElementById("htfZoneStatus").innerText = "ZONE: " + zone;
    document.getElementById("htfZoneDetail").innerText = detail;
    document.getElementById("htfZoneStatus").className = "status " + color;
}

function tacticalDisciplineLayer(h1, m30, m15, m5, flow, pressure, finalSignal, breathingMode){

    let zoneText = document.getElementById("htfZoneStatus").innerText;
    let finalBox = document.getElementById("finalStatus");
    let commanderBox = document.getElementById("tacticalCommanderBox");

    if(breathingMode === "BLOCK_LTF" || breathingMode === "BLOCK_HTF"){
        commanderBox.innerText =
        "🔴 BLOCK – OVEREXTENDED\n\nHarga sudah terlalu jauh.\nTunggu retrace dulu.";
        finalBox.innerText = "🔴 BLOCK – WAIT RETRACE";
        finalBox.className = "status big red";
        return;
    }

    if(breathingMode === "SCALP_LTF" || breathingMode === "SCALP_HTF"){
        commanderBox.innerText =
        "🟡 SCALP ONLY\n\nSudah panas. Ambil cepat. Jangan jadi paus.";
        finalBox.innerText = "🟡 SCALP ONLY";
        finalBox.className = "status big yellow";
        return;
    }

    let mode = "";
    let message = "";
    let colorClass = "gray";

    // ===== BLOCK ENTRY =====
    if(zoneText.includes("DISTRIBUTION") && h1 === "BUY" && pressure <= 1){
        mode = "🔴 ENTRY BLOCKED";
        message = "Zona distribusi + tekanan lemah. DILARANG ENTRY.";
        colorClass = "red";
    }
    else if(zoneText.includes("ACCUMULATION") && h1 === "SELL" && pressure <= 1){
        mode = "🔴 ENTRY BLOCKED";
        message = "Zona akumulasi + tekanan lemah. DILARANG ENTRY.";
        colorClass = "red";
    }

    // ===== SCALP ONLY =====
    else if(zoneText.includes("DISTRIBUTION") && h1 === "BUY"){
        mode = "🟡 SCALP ONLY";
        message = "Dekat H4 High. Entry kecil saja. NO HOLD.";
        colorClass = "yellow";
    }
    else if(zoneText.includes("ACCUMULATION") && h1 === "SELL"){
        mode = "🟡 SCALP ONLY";
        message = "Dekat H4 Low. Entry kecil saja. NO HOLD.";
        colorClass = "yellow";
    }

    // ===== CONTINUATION =====
    else if(h1 === m30 && m30 === m15 && m15 === m5 && pressure >= 3){
        mode = "🟢 CONTINUATION VALID";
        message = "Struktur sinkron & tekanan kuat. Entry disiplin SL.";
        colorClass = "green";
    }

    // ===== DEFAULT =====
    else{
        mode = "⚖️ WAIT / SCALP MODE";
        message = "Kondisi tidak kuat. Hindari overlot.";
        colorClass = "gray";
    }

    commanderBox.innerText = mode + "\n\n" + message;

    // DISPLAY OVERRIDE (VISUAL ONLY)
    finalBox.innerText = mode;
    finalBox.className = "status big " + colorClass;
}

function breathingControlLayer(price, h1, m15, m5, pressure){

    if(!levels) return { mode:null };

    let result = { mode:null };

    // ===== LTF RANGE CHECK (M15 BASE) =====
    let m15Range = levels.M15.high - levels.M15.low;
    if(m15Range > 0){
        let m15Progress = (price - levels.M15.low) / m15Range;

        if(m5 === "BUY" && m15 === "BUY" && pressure >= 3){

            if(m15Progress >= 0.85){
                result.mode = "BLOCK_LTF";
            }
            else if(m15Progress >= 0.70){
                result.mode = "SCALP_LTF";
            }
        }

        if(m5 === "SELL" && m15 === "SELL" && pressure >= 3){

            if(m15Progress <= 0.15){
                result.mode = "BLOCK_LTF";
            }
            else if(m15Progress <= 0.30){
                result.mode = "SCALP_LTF";
            }
        }
    }

    // ===== HTF RANGE CHECK (H1 BASE) =====
    let h1Range = levels.H1.high - levels.H1.low;
    if(h1Range > 0){
        let h1Progress = (price - levels.H1.low) / h1Range;

        let zoneText = document.getElementById("htfZoneStatus").innerText;

        if(h1 === "BUY" && zoneText.includes("DISTRIBUTION")){

            if(h1Progress >= 0.80){
                result.mode = "BLOCK_HTF";
            }
            else if(h1Progress >= 0.65){
                result.mode = "SCALP_HTF";
            }
        }

        if(h1 === "SELL" && zoneText.includes("ACCUMULATION")){

            if(h1Progress <= 0.20){
                result.mode = "BLOCK_HTF";
            }
            else if(h1Progress <= 0.35){
                result.mode = "SCALP_HTF";
            }
        }
    }

    return result;
}

function saveState(){
    const state = { m5Memory, levels, institutional, lockedHour, logData, inputs:{ h1h:h1h.value, h1l:h1l.value, m30h:m30h.value, m30l:m30l.value, m15h:m15h.value, m15l:m15l.value, h4h:h4h.value, h4l:h4l.value, h2h:h2h.value, h2l:h2l.value, rr:rrInput.value }, newsAlerts: activeNewsAlerts, offset: MT5_OFFSET_HOURS, manualBias };
    localStorage.setItem("GIP_SOVEREIGN_STATE", JSON.stringify(state));
}

function loadState(){
    const saved = localStorage.getItem("GIP_SOVEREIGN_STATE");
    if(!saved) return;
    const state = JSON.parse(saved);
    m5Memory = state.m5Memory || [];
    levels = state.levels || null;
    institutional = state.institutional || null;
    lockedHour = state.lockedHour || null;
    logData = state.logData || [];
    activeNewsAlerts = state.newsAlerts || [];
    MT5_OFFSET_HOURS = state.offset || 0;
    manualBias = state.manualBias || null;
    if(state.inputs){ h1h.value = state.inputs.h1h; h1l.value = state.inputs.h1l; m30h.value = state.inputs.m30h; m30l.value = state.inputs.m30l; m15h.value = state.inputs.m15h; m15l.value = state.inputs.m15l; h4h.value = state.inputs.h4h; h4l.value = state.inputs.h4l; h2h.value = state.inputs.h2h; h2l.value = state.inputs.h2l; rrInput.value = state.inputs.rr; }
    updateM5SlotsForFlow();
    document.getElementById("log").innerText = logData.join("\n");
    document.getElementById("manualBiasDisplay").innerText = manualBias ? "Bias: " + manualBias : "Bias: -";
    if(levels) processEngine(); 
    updateAlertUI();
}

function addM5Candle() {
    let h = parseFloat(document.getElementById("m5_high").value);
    let l = parseFloat(document.getElementById("m5_low").value);
    let c = parseFloat(document.getElementById("m5_close").value);
    if (isNaN(h) || isNaN(l) || isNaN(c)) { alert("⚠️ M5 belum lengkap"); return; }
    if (m5Memory.length >= 12) m5Memory.shift();
    m5Memory.push({ high: h, low: l, close: c });
    updateM5SlotsForFlow();
    document.getElementById("m5_high").value = "";
    document.getElementById("m5_low").value = "";
    document.getElementById("m5_close").value = "";
    processEngine();
    saveState();
}

function updateM5SlotsForFlow() {
    for (let i = 1; i <= 12; i++) {
        let inputField = document.getElementById("m5_" + i);
        if (m5Memory[i-1]) inputField.value = m5Memory[i-1].close;
        else inputField.value = "";
    }
}

function lockLevels(){
    let now = getMT5Time().getHours(); 
    levels={
        H1:{high:parseFloat(h1h.value),low:parseFloat(h1l.value)},
        M30:{high:parseFloat(m30h.value),low:parseFloat(m30l.value)},
        M15:{high:parseFloat(m15h.value),low:parseFloat(m15l.value)}
    };
    if(Object.values(levels).some(tf=>isNaN(tf.high)||isNaN(tf.low))){alert("Isi level valid.");return;}
    lockedHour=now;
    document.getElementById("lockInfo").innerText="Structure locked jam "+now+":00 (MT5 Time)";
    saveState();
}

function setInstitutional(){
    institutional={
        H4:{high:parseFloat(h4h.value),low:parseFloat(h4l.value)},
        H2:{high:parseFloat(h2h.value),low:parseFloat(h2l.value)}
    };
    document.getElementById("institutionInfo").innerText="Filter aktif.";
    saveState();
}

function getM5(){
    let arr=[];
    for(let i=1;i<=12;i++){
        let v=parseFloat(document.getElementById("m5_"+i).value);
        if(!isNaN(v))arr.push(v);
    }
    return arr;
}

function processEngine(){
    if(!levels)return;
    let arr=getM5();
    if(arr.length<2)return;
    let price=arr[arr.length-1];
    let prev=arr[arr.length-2];

    function breakSignal(tf){
        let high=levels[tf].high, low=levels[tf].low;
        if(prev>high && price>high)return "BUY";
        if(prev<low && price<low)return "SELL";
        return "WAIT";
    }

    let h1=breakSignal("H1");
    let m30=breakSignal("M30");
    let m15=breakSignal("M15");
    let m5=price>prev?"BUY":"SELL";

    let flowSig="NEUTRAL";
    if(arr.length>=5){
        let up=0,down=0;
        for(let i=arr.length-4;i<arr.length;i++){
            if(arr[i]>arr[i-1])up++;
            else if(arr[i]<arr[i-1])down++;
        }
        if(up>=4)flowSig="STRONG_BUY";
        else if(down>=4)flowSig="STRONG_SELL";
    }

    let pressure=0, side=null;
    for(let i=arr.length-1;i>=0;i--){
        let p=arr[i];
        if(p>levels.M15.high){ if(side==="SELL")break; side="BUY"; pressure++; }
        else if(p<levels.M15.low){ if(side==="BUY")break; side="SELL"; pressure++; }
        else break;
    }

    // ===============================
    // UPDATE STRUCTURAL & MAGNET & PSYCHO FIRST
    // ===============================
    updateStructuralMission();
    updateH1Magnet();
    updatePsychologyZone();

    // ===============================
    // CORE SCORE CALCULATION
    // ===============================

    let score = 0;

    score += h1==="BUY"?4:h1==="SELL"?-4:0;
    score += m30==="BUY"?3:m30==="SELL"?-3:0;
    score += m15==="BUY"?2:m15==="SELL"?-2:0;
    score += m5==="BUY"?1:-1;
    score += flowSig==="STRONG_BUY"?2:flowSig==="STRONG_SELL"?-2:0;
    score += pressure;

    // ===== MAGNET WEIGHT =====
    if (magnetData && structuralMission["structuralH1"]) {
        let structuralDir = structuralMission["structuralH1"].direction;

        if (magnetData.direction === structuralDir) {

            // strength max 5 supaya tidak overboost
            let magnetBoost = Math.min(5, magnetData.strength);

            score += magnetBoost;
        }
    }

    // ===============================
    // STRUCTURAL CONFIRM MODE
    // ===============================

    let h1S  = structuralMission["structuralH1"];
    let m30S = structuralMission["structuralM30"];
    let m15S = structuralMission["structuralM15"];
    let m5S  = structuralMission["structuralM5"];

    // Structural Boost / Reduce (Tidak Nol-kan Score)

    if (h1S && m30S && m15S) {

        // 3 Layer Sinkron
        if (
            h1S.direction === m30S.direction &&
            h1S.direction === m15S.direction
        ) {
            score += 4; // boost kalau sinkron
        }
        else {
            score -= 2; // kurangi kalau tidak sinkron
        }

        // M5 melawan H1
        if (m5S && m5S.direction !== h1S.direction) {
            score -= 3;
        }
    }

    // ===== MANUAL BIAS LOCK =====
    if (manualBias) {
        if (m5 !== manualBias) {
            score -= 10; // penalti besar jika melawan bias
        } else {
            score += 2; // reward kecil jika searah
        }
    }

    // ===============================
    // FINAL DETERMINATION
    // ===============================

    let final = "NETRAL";

    if(score>=10)final="🚀 GOLDEN BUY";
    else if(score<=-10)final="🚀 GOLDEN SELL";
    else if(score>=6)final="🔥 DOMINASI BUY";
    else if(score<=-6)final="🔥 DOMINASI SELL";

    h1Status.innerText="H1: "+h1;
    m30Status.innerText="M30: "+m30;
    m15Status.innerText="M15: "+m15;
    m5Status.innerText="M5: "+m5;
    flowStatus.innerText="FLOW: "+flowSig;
    pressureStatus.innerText="PRESSURE: "+pressure;

    finalStatus.innerText="FINAL: "+final;

    if(final.includes("GOLDEN")){
        finalStatus.className="status big green";
    } else if(final.includes("DOMINASI")){
        finalStatus.className="status big yellow";
    } else {
        finalStatus.className="status big gray";
    }
    confidenceBar.style.width=Math.min(100,Math.abs(score)*5)+"%";

    function calcMission(tf, currentSignal) {
        let range = levels[tf].high - levels[tf].low;
        if(currentSignal==="BUY") return (levels[tf].high + (range*0.618)).toFixed(5);
        if(currentSignal==="SELL") return (levels[tf].low - (range*0.618)).toFixed(5);
        return "-";
    }
    
    missionH1.innerText = "H1 Target: " + calcMission("H1", h1);
    missionM30.innerText = "M30 Target: " + calcMission("M30", m30);
    missionM15.innerText = "M15 Target: " + calcMission("M15", m15);
    missionM5.innerText = "M5 Target: " + (m5==="BUY" ? (price + (price*0.0008)).toFixed(5) : (price - (price*0.0008)).toFixed(5));

    deepConclusion.innerText = `FLOW: ${flowSig}\nSTRUCTURE: ${h1===m30 && h1!=="WAIT" ? "SYNC" : "DIVERGENT"}\nFINAL: ${final}`;

    // === RISK ENGINE DISCIPLINE PATCH (V.2.4 PERFECT LOGIC) ===
    let rr = parseFloat(rrInput.value);
    let slVal = null, tradeSignal = null;

    if(h1 !== "WAIT"){
        tradeSignal = h1;
        slVal = h1 === "BUY" ? levels.M15.low : levels.M15.high;
    }
    else if(m15 !== "WAIT"){
        tradeSignal = m15;
        slVal = m15 === "BUY" ? levels.M15.low : levels.M15.high;
    }
    else {
        tradeSignal = m5;
        let lastM5 = m5Memory[m5Memory.length-1];
        slVal = m5 === "BUY" ? lastM5.low : lastM5.high;
    }

    // UPDATED LOGIC: Strict comparison for Null-Safety
    if(tradeSignal && slVal !== null){
        let dist = Math.abs(price - slVal);
        let tpVal = tradeSignal === "BUY" ? (price + (dist * rr)) : (price - (dist * rr));
        entry.innerText = "Entry: " + price.toFixed(5);
        sl.innerText = "Stop Loss: " + slVal.toFixed(5);
        tp.innerText = "Take Profit: " + tpVal.toFixed(5);
    }
    
    let now = getMT5Time();
    let time = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');
    logData.push(`[${time}] BIAS: ${h1} | Price: ${price}`);
    if(logData.length > 50) logData.shift();
    document.getElementById("log").innerText = logData.join("\n");
    detectHTFExtreme(price);

    let breathing = breathingControlLayer(price, h1, m15, m5, pressure);

    tacticalDisciplineLayer(h1, m30, m15, m5, flowSig, pressure, final, breathing.mode);

    // ===== ADDED CALL =====
    structuralTacticalGuidance(); // Tambahan guidance

    saveState();
}

function exportData(){
    const data = localStorage.getItem("GIP_SOVEREIGN_STATE");
    if(!data) return;
    const blob = new Blob([data], {type:"application/json"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "GIP_BACKUP.json";
    link.click();
}

function importData(){
    const input = document.createElement("input");
    input.type = "file";
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = event => { localStorage.setItem("GIP_SOVEREIGN_STATE", event.target.result); location.reload(); };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}

function resetSystem(){ if(confirm("Reset semua data?")){ localStorage.removeItem("GIP_SOVEREIGN_STATE"); location.reload(); } }
function resetStructureOnly() { levels = null; h1h.value = ""; h1l.value = ""; m30h.value = ""; m30l.value = ""; m15h.value = ""; m15l.value = ""; document.getElementById("lockInfo").innerText = "Structure cleared."; h1Status.innerText="H1: WAIT"; m30Status.innerText="M30: WAIT"; m15Status.innerText="M15: WAIT"; finalStatus.innerText="FINAL: -"; confidenceBar.style.width="0%"; missionH1.innerText="H1 Target: -"; missionM30.innerText="M30 Target: -"; missionM15.innerText="M15 Target: -"; saveState(); }
function resetFilterOnly() { institutional = null; h4h.value = ""; h4l.value = ""; h2h.value = ""; h2l.value = ""; document.getElementById("institutionInfo").innerText = "Filter cleared."; saveState(); }
function resetM5Only() { m5Memory = []; for (let i = 1; i <= 12; i++) { document.getElementById("m5_" + i).value = ""; } flowStatus.innerText = "FLOW: -"; pressureStatus.innerText = "PRESSURE: 0"; m5Status.innerText = "M5: WAIT"; finalStatus.innerText = "FINAL: -"; confidenceBar.style.width = "0%"; missionM5.innerText = "M5 Target: -"; entry.innerText = ""; sl.innerText = ""; tp.innerText = ""; deepConclusion.innerText = ""; saveState(); }

function safeAutoUpdateTF() {
    if (m5Memory.length < 3) return;
    let last3 = m5Memory.slice(-3);
    document.getElementById("m15h").value = Math.max(...last3.map(c => c.high)).toFixed(5);
    document.getElementById("m15l").value = Math.min(...last3.map(c => c.low)).toFixed(5);
    if (m5Memory.length >= 6) {
        let last6 = m5Memory.slice(-6);
        document.getElementById("m30h").value = Math.max(...last6.map(c => c.high)).toFixed(5);
        document.getElementById("m30l").value = Math.min(...last6.map(c => c.low)).toFixed(5);
    }
}

function setNewsAlert() { const time = document.getElementById("newsTime").value; const title = document.getElementById("newsTitle").value || "Market Event"; if(!time) return; activeNewsAlerts.push({ time, title, triggered: false }); updateAlertUI(); saveState(); }
function updateAlertUI() { const container = document.getElementById("activeAlerts"); container.innerHTML = activeNewsAlerts.map((n, idx) => `<div>• ${n.time} - ${n.title} <span onclick="removeAlert(${idx})" style="color:red; cursor:pointer;">[x]</span></div>`).join(''); }
function removeAlert(idx) { activeNewsAlerts.splice(idx, 1); updateAlertUI(); saveState(); }
function checkNewsAlerts(currentTime) { const curShort = currentTime.substring(0, 5); activeNewsAlerts.forEach(alertObj => { if(alertObj.time === curShort && !alertObj.triggered) { alertObj.triggered = true; alert(`📢 NEWS ALERT: ${alertObj.title}`); logData.push(`[${currentTime}] ⚠️ NEWS: ${alertObj.title}`); document.getElementById("log").innerText = logData.join("\n"); } }); }

// ===== STRUCTURAL MISI PRO (SPESIALIS CANDLES STYLE) =====
function updateStructuralMission() {

    if (!levels || m5Memory.length < 8) {
        structuralH1.innerText = "H1 Structural: -";
        structuralM30.innerText = "M30 Structural: -";
        structuralM15.innerText = "M15 Structural: -";
        structuralM5.innerText = "M5 Structural: -";
        return;
    }

    function detectStructural(tfSize, element, tfLevels) {

        let candles = m5Memory.slice(-tfSize * 4);
        if (candles.length < tfSize * 4) return;

        let highs = candles.map(c => c.high);
        let lows  = candles.map(c => c.low);

        let baseHigh  = Math.max(...highs);
        let baseLow   = Math.min(...lows);
        let baseRange = baseHigh - baseLow;

        if (baseRange <= 0) {
            structuralMission[element.id] = null;
            element.innerText = "NONE";
            element.style.background = "";
            return;
        }

        // ==============================
        // 🔵 PURE SIDEWAYS VALIDATION
        // ==============================

        let overlapCount = 0;
        let tightCount   = 0;

        let avgRange = candles.reduce((sum,c)=>sum+(c.high-c.low),0) / candles.length;

        for (let i = 1; i < candles.length; i++) {

            if (
                candles[i].low <= candles[i-1].high &&
                candles[i].high >= candles[i-1].low
            ) overlapCount++;

            let cRange = candles[i].high - candles[i].low;

            if (cRange <= avgRange * 0.8) tightCount++;
        }

        let overlapValid =
            overlapCount >= (candles.length * 0.75) &&
            tightCount   >= (candles.length * 0.75);

        if (!overlapValid) {
            structuralMission[element.id] = null;
            element.innerText = "NONE";
            element.style.background = "";
            return;
        }

        // ==============================
        // 🔵 IMPULSE BEFORE BASE
        // ==============================

        let impulse = m5Memory.slice(-(tfSize * 8), -(tfSize * 4));
        if (impulse.length < tfSize * 4) return;

        let impulseStart = impulse[0].close;
        let impulseEnd   = impulse[impulse.length - 1].close;
        let direction    = impulseEnd > impulseStart ? "BUY" : "SELL";

        // ==============================
        // 🔵 SPION KIRI SWING
        // ==============================

        let target = null;

        for (let i = m5Memory.length - (tfSize * 4 + 1); i > 1; i--) {

            if (direction === "BUY") {
                if (
                    m5Memory[i].high > m5Memory[i-1].high &&
                    m5Memory[i].high > m5Memory[i+1].high &&
                    m5Memory[i].high > baseHigh
                ) {
                    target = m5Memory[i].high;
                    break;
                }
            }

            if (direction === "SELL") {
                if (
                    m5Memory[i].low < m5Memory[i-1].low &&
                    m5Memory[i].low < m5Memory[i+1].low &&
                    m5Memory[i].low < baseLow
                ) {
                    target = m5Memory[i].low;
                    break;
                }
            }
        }

        if (!target) {
            structuralMission[element.id] = null;
            element.innerText = "NO TARGET";
            return;
        }

        let price = m5Memory[m5Memory.length - 1].close;

        // ==============================
        // 🔵 PROGRESS %
        // ==============================

        let progress = direction === "BUY"
            ? (price - baseLow) / (target - baseLow)
            : (baseHigh - price) / (baseHigh - target);

        progress = Math.max(0, Math.min(progress, 1));

        // ==============================
        // 🔴 INFORMASI PERUBAHAN HARGA
        // ==============================

        let failedMission = false;
        let currentPressure = parseInt(pressureStatus.innerText.split(": ")[1]) || 0;

        if (m5Memory.length >= 3) {

            let last  = m5Memory[m5Memory.length - 1];
            let prev1 = m5Memory[m5Memory.length - 2];
            let prev2 = m5Memory[m5Memory.length - 3];

            let twoOpposite =
                direction === "BUY"
                ? (last.close < prev1.close && prev1.close < prev2.close)
                : (last.close > prev1.close && prev1.close > prev2.close);

            let breakBase =
                direction === "BUY"
                ? last.close < baseLow
                : last.close > baseHigh;

            let pressureDrop = currentPressure <= 1;

            // 🔵 REJECTION CONFIRMATION
            let rejection = false;

            let bodySize = Math.abs(last.close - prev1.close);

            if (direction === "BUY") {
                let upperWick = last.high - Math.max(last.close, prev1.close);
                if (upperWick > bodySize * 1.5) rejection = true;
            }

            if (direction === "SELL") {
                let lowerWick = Math.min(last.close, prev1.close) - last.low;
                if (lowerWick > bodySize * 1.5) rejection = true;
            }

            if (twoOpposite && breakBase && pressureDrop && rejection) {
                failedMission = true;
            }
        }

        if (failedMission) {
            structuralMission[element.id] = null;
            element.style.background = "#ff0000";
            element.innerText = "MISSION FAILED";
            return;
        }

        // ==============================
        // 🔵 AUTO SHIFT STRONG BODY
        // ==============================

        let last = m5Memory[m5Memory.length - 1];
        let prevClose = m5Memory[m5Memory.length - 2].close;
        let body = Math.abs(last.close - prevClose);
        let fullRange = last.high - last.low;
        let strongBody = (body / fullRange) >= 0.7;

        if (
            (direction === "BUY" && price >= target) ||
            (direction === "SELL" && price <= target)
        ) {
            if (strongBody && currentPressure >= 3) {
                target = direction === "BUY"
                    ? target + baseRange
                    : target - baseRange;
            }
        }

        element.innerText =
            `${direction} → ${target.toFixed(5)} (${Math.floor(progress*100)}%)`;

        element.style.background = "";

        structuralMission[element.id] = {
            direction: direction,
            target: target,
            progress: Math.floor(progress * 100)
        };
    }

    detectStructural(12, structuralH1, levels.H1);
    detectStructural(6, structuralM30, levels.M30);
    detectStructural(3, structuralM15, levels.M15);
    detectStructural(1, structuralM5, levels.M5);
}

// ===== H1 MAGNET (CLUSTER) =====
function updateH1Magnet(){

    if(m5Memory.length < 20){
        magnetData = null;
        return;
    }

    let recent = m5Memory.slice(-36);
    let closes = recent.map(c=>c.close);

    let min = Math.min(...closes);
    let max = Math.max(...closes);
    let range = max - min;
    if(range <= 0) return;

    let tolerance = range * 0.02;

    let clusters = [];

    closes.forEach(price=>{
        let found = false;

        for(let c of clusters){
            if(Math.abs(c.level - price) <= tolerance){
                c.count++;
                found = true;
                break;
            }
        }

        if(!found){
            clusters.push({level:price,count:1});
        }
    });

    clusters.sort((a,b)=>b.count-a.count);

    let strongest = clusters[0];
    if(!strongest) return;

    let currentPrice = closes[closes.length-1];

    let direction = currentPrice < strongest.level ? "BUY" : "SELL";

    magnetData = {
        level: strongest.level,
        direction: direction,
        strength: strongest.count
    };
}

// ===== PSYCHOLOGY ZONE DETECTOR (WARNING ONLY) =====
function updatePsychologyZone(){

    if(m5Memory.length < 30){
        psychoZone = null;
        return;
    }

    // ambil ± 1 H1 periode (36 M5)
    let recent = m5Memory.slice(-36);

    let highs = recent.map(c=>c.high);
    let lows  = recent.map(c=>c.low);

    let min = Math.min(...lows);
    let max = Math.max(...highs);

    let range = max - min;
    if(range <= 0) return;

    let bucketSize = range / 12; // bagi jadi 12 zona
    let buckets = [];

    for(let i=0;i<12;i++){
        buckets.push({
            low: min + (bucketSize*i),
            high: min + (bucketSize*(i+1)),
            touch:0,
            rejection:0
        });
    }

    recent.forEach((c,i)=>{
        buckets.forEach(b=>{
            if(c.high >= b.low && c.low <= b.high){
                b.touch++;
            }

            if(i>0){
                let prev = recent[i-1];
                let body = Math.abs(c.close - prev.close);
                let upperWick = c.high - Math.max(c.close, prev.close);
                let lowerWick = Math.min(c.close, prev.close) - c.low;

                if(upperWick > body*1.2 || lowerWick > body*1.2){
                    if(c.high >= b.low && c.low <= b.high){
                        b.rejection++;
                    }
                }
            }
        });
    });

    buckets.sort((a,b)=> (b.touch + b.rejection) - (a.touch + a.rejection));

    let strongest = buckets[0];

    if(!strongest || strongest.touch < 4){
        psychoZone = null;
        return;
    }

    let mid = (strongest.low + strongest.high)/2;
    let currentPrice = m5Memory[m5Memory.length-1].close;

    let direction = currentPrice < mid ? "BUY" : "SELL";

    psychoZone = {
        level: mid,
        direction: direction,
        strength: strongest.touch + strongest.rejection
    };
}

// ===== STRUCTURAL TACTICAL GUIDANCE (OBSERVER ONLY) =====
function structuralTacticalGuidance() {

    let box = document.getElementById("tacticalCommanderBox");

    let h1  = structuralMission["structuralH1"];
    let m30 = structuralMission["structuralM30"];
    let m15 = structuralMission["structuralM15"];
    let m5  = structuralMission["structuralM5"];

    if (!h1 || !m15) return;

    // ===== H1 & M15 SEARAH =====
    if (h1.direction === "BUY" && m15.direction === "BUY") {
        box.innerText += "\nAmbil naik-naiknya saja. Tunggu retrace kecil baru gas.";
    }

    if (h1.direction === "SELL" && m15.direction === "SELL") {
        box.innerText += "\nAmbil turun-turunnya saja. Tunggu pullback kecil baru gas.";
    }

    // ===== COUNTER TREND =====
    if (m5 && h1.direction !== m5.direction) {
        box.innerText += "\nIni counter trend. Siap floating kalau maksa.";
    }

    // ===== DEKAT TARGET =====
    if (h1.progress >= 85) {
        box.innerText += "\nDekat target. Jangan overlot. Jangan jadi paus.";
    }

    // ===== MAGNET INFO =====
    if (magnetData) {
        box.innerText += `\nMagnet H1: ${magnetData.level.toFixed(5)} (${magnetData.direction})`;
    }

    // ===== PSYCHOLOGY WARNING =====
    if(psychoZone){

        let price = m5Memory[m5Memory.length-1].close;
        let distance = Math.abs(price - psychoZone.level);

        if(distance < (price*0.001)){ // dekat zona

            if(psychoZone.direction === "SELL"){
                box.innerText += "\nZona bolak-balik atas. Jangan hold lama.";
            }

            if(psychoZone.direction === "BUY"){
                box.innerText += "\nZona bolak-balik bawah. Hati-hati mental market.";
            }
        }
    }

    // ===== MANUAL BIAS INFO =====
    if (manualBias) {
        box.innerText += `\nManual Bias: ${manualBias}`;
    }
}

window.addEventListener("load", () => { loadState(); startMT5Clock(); const originalAdd = addM5Candle; addM5Candle = function() { originalAdd(); safeAutoUpdateTF(); }; });
window.addEventListener("beforeunload", saveState);
</script>
</body>
</html>